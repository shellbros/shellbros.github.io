<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
	<meta http-equiv="Expires" content="0" />
	<meta http-equiv="Expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	<meta http-equiv="Pragma" content="no-cache" />

    <script>var firebase;</script>
    <script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/firebaseui/2.7.0/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.7.0/firebaseui.css" />
   

    <title>Firebase Tester</title>
    
    <script>
        var firebaseUi = null;
        var firebaseUser = null;

        String.prototype.format = String.prototype.f = function() {
            var s = this,
                i = arguments.length;

            while (i--) {
                s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
            }
            return s;
        };

        function writeMsg(s) {
            console.log(s);
            document.getElementById('msg').innerHTML += '<br/>&raquo; ' + s;
        }

        function writeFirebaseInfo(firebaseUser) {
            document.getElementById('isAnon').innerHTML = 'Anonymous: ' + firebaseUser.isAnonymous;
            document.getElementById('firebaseId').innerHTML = 'ID: ' + firebaseUser.uid;
            document.getElementById('firebaseUser').innerHTML = 'User: ' + JSON.stringify(firebaseUser);
        }


        function start () {
            var config = {
                apiKey: "AIzaSyDP4SIjKaw6A4c-zvfYxICpbEjn1rRnN50",
                authDomain: "shellshockio-181719.firebaseapp.com",
                databaseURL: "https://shellshockio-181719.firebaseio.com",
                projectId: "shellshockio-181719",
                storageBucket: "shellshockio-181719.appspot.com",
                messagingSenderId: "68327206324"
            }

            firebase.initializeApp(config);
            
            firebase.auth().onAuthStateChanged( (user) => {
                if (user) {
                    //writeMsg('SignIn auth provider: ' + firebaseUser.providerData[0].providerId);
                    // We're signed into Firebase. If this is an email/password login,
                    // and user has yet to verify email address, do so here
                    writeMsg('Firebase user found!');
                    writeFirebaseInfo(user);
                    
                    // if (firebaseUser !== null) {
                    //     writeMsg('Previous Firebase ID: {0}, new ID: {1}'.format(firebaseUser.uid, user.uid));
                    //     writeMsg('Previous Firebase anon: {0}, new: {1}'.format(firebaseUser.isAnonymous, user.isAnonymous));
                    // }

                    firebaseUser = user;

                    writeMsg('provider data: ' + JSON.stringify(firebaseUser.providerData));
                    if (firebaseUser.providerData && firebaseUser.providerData.length > 0) {
                        if (!firebaseUser.emailVerified && firebaseUser.providerData[0].providerId == 'password') {
                            writeMsg('Email not yet verified');
                            return;
                        }
                    }
                } else {
                    writeMsg('No firebase account');
                    doAnonymousSignin();
                }
            });
        }

        function doAnonymousSignin() {
            firebase.auth().signInAnonymously().catch(function(error) {
                writeMsg('failed anonymous signin, code: {0}, msg: {1}'.format(error.code, error.message));
            })
        }

        function signIn () {
            if (!firebaseUi) {
                firebaseUi = new firebaseui.auth.AuthUI(firebase.auth());
            }

            var firebaseUiConfig = createFirebaseUiConfig();
            firebaseUi.start('#firebaseui-auth-container', firebaseUiConfig);
        }

        function createFirebaseUiConfig () {
            return {
                callbacks: {
                    signInSuccessWithAuthResult: firebaseUiSignInSuccess,
                    signInFailure: firebaseUiSignInFailure,
                    uiShown: function (e) { writeMsg('Showed firebase UI'); }
                },
                autoUpgradeAnonymousUsers: true,
                credentialHelper: firebaseui.auth.CredentialHelper.NONE,
                signInFlow: 'popup',
                //signInSuccessUrl: 'https://shellshock.io',user.getMetadata();
                signInOptions: [
                    // Leave the lines as is for the providers you want to offer your users.
                    {
                        provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
                        requireDisplayName: false,
                    },
                    firebase.auth.FacebookAuthProvider.PROVIDER_ID,
                    firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                ],
                // Terms of service url.
                tosUrl: 'http://www.bluewizard.com/terms'
            };
        }

        function firebaseUiSignInSuccess (firebaseResult, redirectUrl) {
            writeMsg('Sign in success');

            writeFirebaseInfo(firebaseUser);

            //console.log(JSON.stringify(firebaseResult));
            //document.getElementById('isNew').innerHTML = firebaseResult.additionalUserInfo.isNewUser ? 'NEW USER' : 'RETURNING USER';
        }

        function firebaseUiSignInFailure (error) {
            if (error.code != 'firebaseui/anonymous-upgrade-merge-conflict') {
                return Promise.resolve();
            }

            console.log('Firebase user upgrade merge conflict')
        }

    </script>
</head>

<body onload="start()">

<div>
    <button onclick="signIn()">Sign In</button>
</div>

<h3>Firebase</h3>
<div id="isNew"></div>
<div id="isAnon"></div>
<div id="firebaseId">None</div>
<div id="firebaseUser"></div>

<h3>Log</h3>
<div id="msg">&raquo; Start</div>

<div id="firebaseui-auth-container"></div>

</body>
</html>