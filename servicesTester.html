<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
	<meta http-equiv="Expires" content="0" />
	<meta http-equiv="Expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	<meta http-equiv="Pragma" content="no-cache" />

    <title>Services Tester</title>
    
    <script>
    String.prototype.format = String.prototype.f = function() {
        var s = this,
            i = arguments.length;

        while (i--) {
            s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
        }
        return s;
    };

    var servicesServer = 'ws://localshelldev.bluewizard.com:4242/';

    function callApi(apiRequest, successCallback, errorCallback, closeCallback) {
        console.log('\'{0}\' api command'.format(apiRequest.cmd));
        try {
            var servicesWs = new WebSocket('wss://' + location.hostname + '/services/');
            console.log(servicesWs);
        } catch (e) {
            console.log(e);
        }

        servicesWs.onopen = function (e) {
            servicesWs.send(JSON.stringify(apiRequest));
            console.log('servicesWs opened, and ' + apiRequest.cmd + ' request sent');
        };

        servicesWs.onmessage = function (e) {
            var response = null;
            try {
                response = JSON.parse(e.data);
            } catch (e) {
                console.log('Invalid data returned from services API');
                errorCallback();
                return;
            }

            if (response.error) {
                console.log(apiRequest.cmd + ' error: ' + JSON.stringify(response.error));
                errorCallback(response);
            } else {
                successCallback(response);
            }

            servicesWs.close();
        };

        servicesWs.onclose = function (e) {
            console.log(apiRequest.cmd + ' servicesWs closed: ' + e.code + ' ' + e.reason);
            if (closeCallback) {
                closeCallback();
            }
        };

        servicesWs.onerror = function (e) {
            errorCallback();
        };
    }

    function doRequest () {
        console.log('calling API...');
        var requestJson = document.getElementById('request').value;
        var request = JSON.parse(requestJson);
        callApi(request, success, error, closed);
    }

    function success (response) {
        console.log('success!');
        console.log('response: ' + JSON.stringify(response));
    }

    function error () {
        console.log('error');
    }

    function closed () {
        console.log('closed');
    }

    function newAnon () {
        document.getElementById('request').value = JSON.stringify({
            cmd: 'auth',
            isAnon: true,
            isNewUser: true,
            firebaseToken: {
                uid: "anontoken1",
            }
        });
    }

    function returningAnon () {
        document.getElementById('request').value = JSON.stringify({
            cmd: 'auth',
            isAnon: true,
            isNewUser: false,
            firebaseToken: {
                uid: "anontoken1",
            }
        });
    }

    function signInFirebase () {
        document.getElementById('request').value = JSON.stringify({
            cmd: 'auth',
            
            firebaseToken: null
        });
    }

    function upgradeAnonToFirebase () {
        document.getElementById('request').value = JSON.stringify({
            cmd: 'auth',
            //token: "firebase creates this",
            token: { // test values
                uid: "c2mvInpXh6MVz9y2WnTGdEbLDGy1",
                email: "matthew+test1@bluewizard.com"
            }
        });
    }

    </script>
</head>

<body>


<div>
    <button onclick="newAnon()">New Anon</button>
    <button onclick="returningAnon()">Returning Anon</button>
    <button onclick="upgradeAnonToFirebase()">Upgrade Anon</button>
    <button onclick="signInFirebase()">Firebase</button>
</div>


<textarea id="request" rows="10" cols="100">
    {
        "cmd": "ping"
    }
</textarea>

<button onclick="doRequest()">Call API</button>

</body>
</html>